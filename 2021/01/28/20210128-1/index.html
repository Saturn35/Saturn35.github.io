<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  

  
    
      
    

    
  

  
    
    
    <link href="https://fonts.cat.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="CVE-2021-1647 0day">










<meta name="description" content="&amp;#x524D;&amp;#x8A00;CVE-2021-1647&amp;#x662F;&amp;#x5FAE;&amp;#x8F6F;&amp;#x5728;2021&amp;#x5E74;1&amp;#x6708;&amp;#x4FEE;&amp;#x590D;&amp;#x7684;Windows Defender&amp;#x7EC4;&amp;#x4EF6;RCE&amp;#x6F0F;&amp;#x6D1E;&amp;#xFF0C;CVSS&amp;#x8BC4;&amp;#x5206;&amp;#x4E3A;7.8&amp;#x5">
<meta name="keywords" content="CVE-2021-1647 0day">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-1647漏洞原理与程序流程分析">
<meta property="og:url" content="https://saturn35.github.io/2021/01/28/20210128-1/index.html">
<meta property="og:site_name" content="Saturn35">
<meta property="og:description" content="&amp;#x524D;&amp;#x8A00;CVE-2021-1647&amp;#x662F;&amp;#x5FAE;&amp;#x8F6F;&amp;#x5728;2021&amp;#x5E74;1&amp;#x6708;&amp;#x4FEE;&amp;#x590D;&amp;#x7684;Windows Defender&amp;#x7EC4;&amp;#x4EF6;RCE&amp;#x6F0F;&amp;#x6D1E;&amp;#xFF0C;CVSS&amp;#x8BC4;&amp;#x5206;&amp;#x4E3A;7.8&amp;#x5">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/1.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/2.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/3.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/4.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/5.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/5a.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/7.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/8.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/9.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/10.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/11.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/12.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/13.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/14.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/15.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/16.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/17.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/18.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/19.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/20.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/21.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/22.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/23.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/24.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/25.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/26.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/27.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/28.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/29.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/30.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/31.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/32.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/33.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/34.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/35.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/36.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/37.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/38.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/39.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/40.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/41.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/42.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/43.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/44.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/45.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/46.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/47.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/48.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/49.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/51.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/52.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/53.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/54.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/55.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/56.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/57.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/58.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/59.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/60.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/61.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/62.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/63.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/64.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/65.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/66.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/67.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/68.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/69.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/70.png">
<meta property="og:image" content="https://saturn35.github.io/2021/01/28/20210128-1/71.gif">
<meta property="og:updated_time" content="2021-01-29T02:33:16.252Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2021-1647漏洞原理与程序流程分析">
<meta name="twitter:description" content="&amp;#x524D;&amp;#x8A00;CVE-2021-1647&amp;#x662F;&amp;#x5FAE;&amp;#x8F6F;&amp;#x5728;2021&amp;#x5E74;1&amp;#x6708;&amp;#x4FEE;&amp;#x590D;&amp;#x7684;Windows Defender&amp;#x7EC4;&amp;#x4EF6;RCE&amp;#x6F0F;&amp;#x6D1E;&amp;#xFF0C;CVSS&amp;#x8BC4;&amp;#x5206;&amp;#x4E3A;7.8&amp;#x5">
<meta name="twitter:image" content="https://saturn35.github.io/2021/01/28/20210128-1/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://saturn35.github.io/2021/01/28/20210128-1/">






  <title>CVE-2021-1647漏洞原理与程序流程分析 | Saturn35</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Saturn35</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>




 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://saturn35.github.io/2021/01/28/20210128-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Saturn35">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Saturn35">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CVE-2021-1647漏洞原理与程序流程分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-28T20:26:20+08:00">
                2021-01-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/01/28/20210128-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/01/28/20210128-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,694
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  34
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a><strong>&#x524D;&#x8A00;</strong></h2><p>CVE-2021-1647&#x662F;&#x5FAE;&#x8F6F;&#x5728;2021&#x5E74;1&#x6708;&#x4FEE;&#x590D;&#x7684;Windows Defender&#x7EC4;&#x4EF6;RCE&#x6F0F;&#x6D1E;&#xFF0C;CVSS&#x8BC4;&#x5206;&#x4E3A;7.8&#x5206;&#xFF0C;&#x4E3A;&#x4E25;&#x91CD;&#x6F0F;&#x6D1E;&#x3002;<br>&#x76EE;&#x524D;&#x5C1A;&#x65E0;&#x76F8;&#x5173;&#x7EC6;&#x8282;&#x7EB0;&#x6F0F;&#xFF0C;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x6837;&#x672C;&#x6700;&#x65E9;&#x7531;&#x63A8;&#x7279;&#x7528;&#x6237; @ccxsaber &#x7206;&#x51FA;&#xFF0C;&#x968F;&#x540E;&#x7531;&#x4F17;&#x591A;&#x5B89;&#x5168;&#x7814;&#x7A76;&#x5458;&#x786E;&#x8BA4;&#x4E3A;1647&#x5728;Windows&#x5E73;&#x53F0;&#x7684;&#x6700;&#x65B0;&#x5229;&#x7528;&#x6837;&#x672C;&#x3002;<br>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x7814;&#x7A76;&#x6F0F;&#x6D1E;&#x539F;&#x7406;&#x76F8;&#x5173;&#x903B;&#x8F91;&#xFF0C;&#x6682;&#x4E0D;&#x6D89;&#x53CA;&#x5229;&#x7528;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/1.png" alt="img"></p>
<p>&#x6D4B;&#x8BD5;&#x73AF;&#x5883;&#xFF1A;win10 1909(18363.1256)<br>&#x5F71;&#x54CD;&#x7248;&#x672C;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">-Microsoft:Microsoft Defender:Windows 8.1 for 32-bit systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 7 for x64-based Systems Service Pack 1</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 7 for 32-bit Systems Service Pack 1</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2016 (Server Core installation)</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2016</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1607 for x64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1607 for 32-bit Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 for x64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 for 32-bit Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server, version 20H2 (Server Core Installation)</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 20H2 for ARM64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 20H2 for 32-bit Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 20H2 for x64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server, version 2004 (Server Core installation)</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 2004 for x64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 2004 for ARM64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 2004 for 32-bit Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server, version 1909 (Server Core installation)</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1909 for ARM64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1909 for x64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1909 for 32-bit Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2019 (Server Core installation)</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2019</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1809 for ARM64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1809 for x64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1809 for 32-bit Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1803 for ARM64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1803 for x64-based Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 10 Version 1803 for 32-bit Systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft System Center 2012 Endpoint Protection</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Security Essentials</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft System Center 2012 R2 Endpoint Protection</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft System Center Endpoint Protection</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2008 for 32-bit Systems Service Pack 2</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows RT 8.1</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows 8.1 for x64-based systems</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2012 R2 (Server Core installation)</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2012 R2</span><br><span class="line"></span><br><span class="line">-Microsoft:Microsoft Defender:Windows Server 2012 (Server Core installation)</span><br></pre></td></tr></table></figure>

<h2 id="0x01-&#x6F0F;&#x6D1E;&#x539F;&#x7406;"><a href="#0x01-&#x6F0F;&#x6D1E;&#x539F;&#x7406;" class="headerlink" title="0x01 &#x6F0F;&#x6D1E;&#x539F;&#x7406;"></a>0x01 &#x6F0F;&#x6D1E;&#x539F;&#x7406;</h2><p>&#x6839;&#x636E;&#x5B89;&#x5168;&#x7814;&#x7A76;&#x4EBA;&#x5458;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;1647&#x4E3A;windows defender&#x626B;&#x63CF;&#x548C;&#x68C0;&#x6D4B;&#x6A21;&#x5757;mpengine.dll&#x4E2D;&#x51FA;&#x73B0;&#x7684;&#x7F13;&#x51B2;&#x533A;&#x6EA2;&#x51FA;&#x6F0F;&#x6D1E;&#xFF0C;&#x5F53;&#x653B;&#x51FB;&#x4EBA;&#x5458;&#x4F7F;&#x7528;&#x6076;&#x610F;&#x6784;&#x9020;&#x7684;PE&#x6837;&#x672C;&#x6587;&#x4EF6;&#xFF0C;&#x53EF;&#x4F7F;&#x5F00;&#x542F;Windows Defenfer&#x5B9E;&#x65F6;&#x9632;&#x62A4;&#x7684;&#x8FDB;&#x884C;&#x8FDC;&#x7A0B;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x3002;</p>
<p>&#x67E5;&#x770B;&#x5229;&#x7528;Windows defender&#x68C0;&#x6D4B;&#x5229;&#x7528;&#x6837;&#x672C;&#x65F6;&#x7684;&#x8FDB;&#x7A0B;&#x6811;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/2.png" alt="img"></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F53;&#x5229;&#x7528;&#x6837;&#x672C;&#x88AB;&#x68C0;&#x6D4B;&#x540E;&#xFF0C;MsMpEng&#x8FDB;&#x7A0B;&#x9000;&#x51FA;&#xFF0C;&#x542F;&#x52A8;cmd&#xFF0C;&#x7236;&#x8FDB;&#x7A0B;&#x5DF2;&#x9000;&#x51FA;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/3.png" alt="img"></p>
<p>&#x6839;&#x636E;git&#x4E0A;<a href="http://github.com/taviso" target="_blank" rel="noopener">taviso</a>&#x7528;&#x6237;&#x4EE5;&#x53CA;google <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1260" target="_blank" rel="noopener">Issue 1260</a>&#x5173;&#x4E8E;MsMpengine&#x7684;&#x63CF;&#x8FF0;&#xFF1A;</p>
<p><font color="#808a87" size="3"><em>MsMpEng&#x662F;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x5728;Windows 8&#x3001;8.1&#x3001;10&#xFF0C;Windows Server 2016&#x7B49;&#x4E0A;&#x542F;&#x7528;&#x7684;&#x6076;&#x610F;&#x8F6F;&#x4EF6;&#x4FDD;&#x62A4;&#x670D;&#x52A1;&#x3002;&#x6B64;&#x5916;&#xFF0C;Microsoft Security Essentials&#xFF0C;System Center Endpoint Protection&#x548C;&#x5176;&#x4ED6;&#x5404;&#x79CD;Microsoft&#x5B89;&#x5168;&#x4EA7;&#x54C1;&#x5171;&#x4EAB;&#x540C;&#x4E00;&#x6838;&#x5FC3;&#x5F15;&#x64CE;&#x3002;</em></font></p>
<p><font color="#808a87" size="3"><em>MsMpEng&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x7CFB;&#x7EDF;x86&#x4EFF;&#x771F;&#x5668;&#xFF0C;&#x8BE5;&#x4EFF;&#x771F;&#x5668;&#x7528;&#x4E8E;&#x6267;&#x884C;&#x4EFB;&#x4F55;&#x770B;&#x8D77;&#x6765;&#x50CF;PE&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x4E0D;&#x53D7;&#x4FE1;&#x4EFB;&#x7684;&#x6587;&#x4EF6;&#x3002; &#x8BE5;&#x6A21;&#x62DF;&#x5668;&#x4EE5;NT AUTHORITY \ SYSTEM&#x7684;&#x8EAB;&#x4EFD;&#x8FD0;&#x884C;&#xFF0C;&#x5E76;&#x4E14;&#x672A;&#x6C99;&#x76D2;&#x5316;&#x3002;</em></font></p>
<p><font color="#808a87" size="3"><em>MsMpEng&#x8D1F;&#x8D23;&#x626B;&#x63CF;&#x548C;&#x5206;&#x6790;&#x7684;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#x79F0;&#x4E3A;mpengine&#x3002; Mpengine&#x662F;&#x4E00;&#x4E2A;&#x5E9E;&#x5927;&#x800C;&#x590D;&#x6742;&#x7684;&#x653B;&#x51FB;&#x9762;&#xFF0C;&#x5305;&#x62EC;&#x7528;&#x4E8E;&#x6570;&#x5341;&#x79CD;&#x6DF1;&#x5965;&#x5B58;&#x6863;&#x683C;&#x5F0F;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x53EF;&#x6267;&#x884C;&#x6253;&#x5305;&#x7A0B;&#x5E8F;&#xFF0C;&#x7528;&#x4E8E;&#x5404;&#x79CD;&#x4F53;&#x7CFB;&#x7ED3;&#x6784;&#x7684;&#x5B8C;&#x6574;&#x7CFB;&#x7EDF;&#x4EFF;&#x771F;&#x5668;&#x548C;&#x7528;&#x4E8E;&#x5404;&#x79CD;&#x8BED;&#x8A00;&#x7684;&#x89E3;&#x91CA;&#x5668;&#x3002; &#x8FDC;&#x7A0B;&#x653B;&#x51FB;&#x8005;&#x90FD;&#x53EF;&#x4EE5;**&#x8BBF;&#x95EE;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x4EE3;&#x7801;&#x3002;</em></font></p>
<p>Black Hat 2018&#x7684;&#x4E00;&#x7BC7;Paper &#x300A;<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Bulazel-Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator.pdf" target="_blank" rel="noopener">Windows Offender&#xFF1A;Windows Defender&#x7684;&#x53CD;&#x75C5;&#x6BD2;&#x6A21;&#x62DF;&#x5668;&#x9006;&#x5411;&#x5DE5;&#x7A0B;&#x539F;&#x7406;</a>&#x300B;&#x4E2D;&#x540C;&#x6837;&#x4ECB;&#x7ECD;&#x4E86;&#x5173;&#x4E8E;Windows Defender&#x6A21;&#x62DF;&#x5668;&#x7684;&#x539F;&#x7406;&#x4EE5;&#x53CA;&#x5B66;&#x4E60;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x5728;taviso&#x7684;git &#x9879;&#x76EE; loadlibrary&#x4ECB;&#x7ECD;&#x4E86;&#x4E00;&#x79CD;&#x5C06;Win dll&#x79FB;&#x690D;&#x5230;Linux&#x4E0A;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x6210;&#x529F;&#x8D8A;&#x8FC7;Windows&#x7684;&#x591A;&#x9879;&#x7F13;&#x89E3;&#x4E0E;&#x5B89;&#x5168;&#x63AA;&#x65BD;&#x3002;`</p>
<p><img src="/2021/01/28/20210128-1/4.png" alt="img"></p>
<p>&#x8A00;&#x5F52;&#x6B63;&#x4F20;&#xFF0C;&#x5E38;&#x89C4;&#x60F3;&#x6CD5;&#xFF0C;&#x542F;&#x52A8;windbg&#x8C03;&#x8BD5;MsMpEng&#x8FDB;&#x7A0B;&#xFF0C;&#x7136;&#x9E45;&#xFF0C;&#x4FDD;&#x62A4;&#x7684;&#x8FDB;&#x7A0B;ring3&#x5E76;&#x6CA1;&#x6709;&#x673A;&#x4F1A;&#x3002;&#x76EE;&#x6D4B;&#x5B58;&#x5728;&#x670D;&#x52A1;&#x548C;&#x9A71;&#x52A8;&#x4FDD;&#x62A4;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/5.png" alt="img"></p>
<p>&#x6B64;&#x65F6;&#x4E00;&#x79CD;&#x60F3;&#x6CD5;&#x662F;&#x76F4;&#x63A5;&#x5185;&#x6838;&#x8C03;&#x8BD5;&#xFF0C;&#x5185;&#x6838;&#x8C03;&#x8BD5;&#x5668;&#x5207;&#x6362;&#x80CC;&#x666F;&#x6587;&#x3002;&#x6216;&#x8005;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x77E5;&#x6F0F;&#x6D1E;&#x5B58;&#x5728;&#x6A21;&#x5757;&#x4E5F;&#x5373;&#x5C31;&#x662F;mpengine.dll&#xFF0C;&#x6216;&#x8BB8;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x4F7F;&#x7528;&#x6A21;&#x7CCA;&#x5668;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x8C03;&#x8BD5;&#x3002;&#x7ED3;&#x679C;&#x6808;&#x56DE;&#x6EAF;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="/2021/01/28/20210128-1/5a.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mpengine!memcpy+0x4e:</span><br><span class="line">7b7d0efe f3a4            rep movs byte ptr es:[edi],byte ptr [esi]</span><br><span class="line">0:000&gt; dd edi</span><br><span class="line">0b8e10d4  00000000 00000000 00000000 00000000</span><br><span class="line">0b8e10e4  00000000 00000000 00000000 00000000</span><br><span class="line">0b8e10f4  00000000 00000000 00000000 00000000</span><br><span class="line">0b8e1104  00000000 00000000 00000000 00000000</span><br><span class="line">0b8e1114  00000000 00000000 00000000 00000000</span><br><span class="line">0b8e1124  00000000 00000000 00000000 00000000</span><br><span class="line">0b8e1134  00000000 00000000 00000000 00000000</span><br><span class="line">0b8e1144  00000000 00000000 00000000 00000000</span><br><span class="line">0:000&gt; dd esi</span><br><span class="line">1c7b3000  ???????? ???????? ???????? ????????</span><br><span class="line">1c7b3010  ???????? ???????? ???????? ????????</span><br><span class="line">1c7b3020  ???????? ???????? ???????? ????????</span><br><span class="line">1c7b3030  ???????? ???????? ???????? ????????</span><br><span class="line">1c7b3040  ???????? ???????? ???????? ????????</span><br><span class="line">1c7b3050  ???????? ???????? ???????? ????????</span><br><span class="line">1c7b3060  ???????? ???????? ???????? ????????</span><br><span class="line">1c7b3070  ???????? ???????? ???????? ????????</span><br><span class="line"></span><br><span class="line">Time Travel Position: 773E67:CAB</span><br><span class="line">eax=34748150 ebx=34748150 ecx=243a41f4 edx=0001fffe esi=0001fffe edi=0001fffe</span><br><span class="line">eip=797080a8 esp=00efd740 ebp=00efd758 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246</span><br><span class="line">mpengine!memcpy_s+0x2d:</span><br><span class="line">797080a8 e8038e2b00      call    mpengine!memcpy (799c0eb0)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    -------------&gt;</span><br><span class="line">    </span><br><span class="line">.text:5A54D593 push ebx</span><br><span class="line">.text:5A54D594 push eax</span><br><span class="line">.text:5A54D595 mov edx, ebx</span><br><span class="line">.text:5A54D597 call memcpy_s</span><br><span class="line"></span><br><span class="line">0:000&gt; g-u</span><br><span class="line">Time Travel Position: 773E67:C97</span><br><span class="line">eax=34748150 ebx=0001fffe ecx=243a41f4 edx=0001fffe esi=34748108 edi=24383e58</span><br><span class="line">eip=798ed597 esp=00efd760 ebp=00efd784 iopl=0         nv up ei pl nz ac pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000216</span><br><span class="line">mpengine!lfind_switch::switch_in+0x167:</span><br><span class="line">798ed597 e8dfaae1ff      call    mpengine!memcpy_s (7970807b)</span><br></pre></td></tr></table></figure>

<p>&#x770B;&#x8D77;&#x6765;&#x662F;&#x8BBF;&#x95EE;&#x6A21;&#x7CCA;&#x7A0B;&#x5E8F;&#x8D8A;&#x754C;&#x8BBF;&#x95EE;&#x5185;&#x5B58;&#xFF0C;&#x800C;&#x4E14;&#x4E3A;&#x6E90;&#x5730;&#x5740;&#xFF0C;&#x4F46;&#x4F3C;&#x4E4E;&#x5E76;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x76EE;&#x6807;&#x7F13;&#x51B2;&#x533A;&#x6EA2;&#x51FA;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5C1D;&#x8BD5;&#x4F7F;&#x7528;gflags.exe&#x624B;&#x52A8;&#x5F00;&#x542F;&#x6211;&#x4EEC;&#x6A21;&#x7CCA;&#x8FDB;&#x7A0B;&#x7684;page heap&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/7.png" alt="img"></p>
<p>&#x7ED3;&#x679C;&#x76F4;&#x63A5;int&#x4E2D;&#x65AD;&#xFF0C;&#x770B;&#x8D77;&#x6765;&#x5F15;&#x64CE;&#x5185;&#x90E8;&#x7684;&#x4FDD;&#x62A4;&#x63AA;&#x65BD;&#x3002;&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x5C1D;&#x8BD5;&#x547D;&#x4EE4;&#x884C;&#x65B9;&#x5F0F;&#x5F00;&#x542F;page heap&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gflags -p /enable xxx.exe /dlls mpengine.dll /full</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/28/20210128-1/8.png" alt="img"></p>
<p>&#x6B64;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x4E86;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x7684;&#x6808;&#x56DE;&#x6EAF;</p>
<p><img src="/2021/01/28/20210128-1/9.png" alt="img"></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4F3C;&#x4E4E;&#x662F;&#x5728;&#x5206;&#x6790;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x91CA;&#x653E;&#x5185;&#x5B58;&#x51FA;&#x73B0;&#x7684;STATUS_FAIL_FAST_EXCEPTION&#x5F02;&#x5E38;&#x9519;&#x8BEF;&#x3002;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x51FD;&#x6570;&#x547D;&#x4E2D;&#x51FA;&#x73B0;&#x4E86;&#x8BF8;&#x5982;</p>
<p>pack\unpack\Asprotect&#x7B49;&#x5173;&#x952E;&#x51FD;&#x6570;&#x540D;&#xFF0C;&#x5BF9;&#x52A0;&#x5BC6;&#x58F3;&#x719F;&#x6089;&#x7684;&#x540C;&#x5FD7;&#x4EEC;&#xFF0C;&#x5E94;&#x8BE5;&#x77E5;&#x9053;Asp&#x52A0;&#x5BC6;&#x58F3;&#x662F;&#x4E00;&#x79CD;&#x5BF9;&#x8F6F;&#x4EF6;&#x7A0B;&#x5E8F;&#x8FDB;&#x884C;&#x52A0;&#x58F3;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4F46;&#x95EE;&#x9898;&#x662F;&#xFF0C;&#x53EA;&#x51FA;&#x73B0;&#x4E86;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x5E76;&#x672A;&#x51FA;&#x73B0;&#x8BBF;&#x95EE;&#x9519;&#x8BEF;&#xFF08;&#x6DE6;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x731C;&#x6D4B;&#x7684;&#x662F;&#xFF0C;&#x76EE;&#x6807;&#x4F4D;&#x7F6E;&#x5C31;&#x5728;&#x8FD9;&#x9644;&#x8FD1;&#xFF0C;&#x56E0;&#x4E3A;&#x6B64;&#x5904;&#x662F;&#x8FDB;&#x884C;PE&#x8131;&#x58F3;&#x89E3;&#x6790;&#x7684;&#x5730;&#x65B9;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x5C06;&#x76EE;&#x5149;&#x6295;&#x5411;<a href="https://github.com/taviso/loadlibrary" target="_blank" rel="noopener">loadlibrary</a>&#x9879;&#x76EE;&#xFF0C;&#x51B3;&#x5B9A;&#x770B;&#x770B;&#x5728;linux&#x662F;&#x5426;&#x6709;&#x673A;&#x4F1A;&#x8131;&#x79BB;windows&#x7684;&#x673A;&#x5236;&#x3002;&#x6211;&#x4EEC;&#x6309;&#x7167;readme&#x4ECB;&#x7ECD;&#x7684;&#x6B65;&#x9AA4;&#xFF0C;&#x4E0B;&#x8F7D;&#x7F16;&#x8BD1;&#x4E86;mpclient&#x7A0B;&#x5E8F;&#xFF0C;&#x4F7F;&#x7528;&#x5B83;</p>
<p>&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x4E86;&#x5982;&#x4E0B;&#x6808;&#x56DE;&#x6EAF;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x5a621100 in _memcpy () at {standard input}:11134</span><br><span class="line">11134   {standard input}: No such file or directory.</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  0x5a621100 in _memcpy () at {standard input}:11134</span><br><span class="line">#1  0x5a4fe19a in _Write_UnplibMemwrite__UAE_NPBXI_Z () at {standard input}:11134</span><br><span class="line">#2  0x5a57f642 in _flush_internal_rOutStream__IAE_AW4uncompress_error_t__PBEI_Z () at {standard input}:11134</span><br><span class="line">#3  0x5a57f455 in _flush_rOutStream__UAE_AW4uncompress_error_t__XZ () at {standard input}:11134</span><br><span class="line">#4  0x5a57f3cd in _UpdateBuffIndexes_rOutStream__IAE_AW4uncompress_error_t__XZ () at {standard input}:11134</span><br><span class="line">#5  0x5a57eb11 in _fputc_rOutStream__QAE_AW4uncompress_error_t__E_Z () at {standard input}:11134</span><br><span class="line">#6  0x5a4c0732 in _OnTheFly_APLib__UAE_AW4uncompress_error_t__PBUunpackdata_t___Z () at {standard input}:11134</span><br><span class="line">#7  0x5a57cc78 in _OnTheFly__YA_AW4uncompress_error_t__PAUunpackdata_t___Z () at {standard input}:11134</span><br><span class="line">#8  0x5a57cba0 in _runpack () at {standard input}:11134</span><br><span class="line">#9  0x45ef8264 in ?? ()</span><br><span class="line">#10 0xf1d4640c in aRsignal_0 () at {standard input}:11134</span><br><span class="line">#11 0x5a423ac0 in sqlite3VdbeMemSetNull () at {standard input}:11134</span><br><span class="line">#12 0xffffffff in aRsignal_0 () at {standard input}:11134</span><br><span class="line">#13 0xffffffff in aRsignal_0 () at {standard input}:11134</span><br><span class="line">#14 0xe79d4800 in aRsignal_0 () at {standard input}:11134</span><br><span class="line">#15 0xffffa8f0 in aRsignal_0 () at {standard input}:11134</span><br><span class="line">#16 0xffffa8a8 in aRsignal_0 () at {standard input}:11134</span><br><span class="line">#17 0xffffaaf4 in aRsignal_0 () at {standard input}:11134</span><br><span class="line">#18 0x5a672ded in SEH_5A56E930 () at {standard input}:11134</span><br><span class="line">#19 0x00000000 in ?? ()</span><br><span class="line"></span><br><span class="line">&#x6CE8;&#x610F;&#xFF1A;&#x7531;&#x4E8E;&#x7B26;&#x53F7;&#x8F6C;&#x6362;&#x95EE;&#x9898;&#xFF0C;gdb&#x4E2D;&#x663E;&#x793A;&#x7684;&#x7B26;&#x53F7;&#x4FE1;&#x606F;&#x5E76;&#x4E0D;&#x662F;&#x90A3;&#x4E48;&#x5B8C;&#x5584;</span><br></pre></td></tr></table></figure>

<p>&#x7ECF;&#x8FC7;&#x4E0A;&#x8FF0;&#x4FE1;&#x606F;&#xFF0C;&#x6211;&#x4EEC;&#x57FA;&#x672C;&#x5F97;&#x5230;&#x4E86;&#x60F3;&#x8981;&#x7684;&#x90E8;&#x5206;&#x7ED3;&#x679C;&#xFF0C;&#x6211;&#x4EEC;&#x5728;IDA&#x4E2D;&#x4E5F;&#x770B;&#x5230;&#x4E86;&#x4E0A;&#x8FF0;&#x51FD;&#x6570;&#x540D;&#x548C;&#x8C03;&#x7528;&#x903B;&#x8F91;&#x3002;</p>
<p>&#x540C;&#x65F6;&#x7ECF;&#x8FC7;&#x540C;&#x4E8B;&#x7684;&#x63D0;&#x9192;&#x548C;&#x5E2E;&#x52A9;&#xFF0C;&#x4ED4;&#x7EC6;&#x7FFB;&#x770B;Gflags&#x624B;&#x518C;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x5728;&#x547D;&#x4EE4;&#x884C;&#x5F00;&#x542F;pageheap&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x5806;&#x5C3A;&#x5BF8;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gflags -p /enable mpscanner.exe /size 8192 8192</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/28/20210128-1/10.png" alt="img"></p>
<p>&#x63A5;&#x7740;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x5982;&#x4E0A;&#x547D;&#x4EE4;&#x884C;&#xFF0C;&#x6307;&#x5B9A;0x2000&#x5927;&#x5C0F;&#xFF0C;&#x91CD;&#x65B0;&#x5728;windows&#x4E0A;&#x8C03;&#x8BD5;&#x6A21;&#x7CCA;&#x7A0B;&#x5E8F;&#xFF0C;&#x6808;&#x56DE;&#x6EAF;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; </span><br><span class="line"> # ChildEBP RetAddr      </span><br><span class="line">00 0019d2f8 79cce19a     mpengine!memcpy+0x4e</span><br><span class="line">01 0019d314 79d4f642     mpengine!UnplibMemwrite::Write+0x2a</span><br><span class="line">02 0019d340 79d4f455     mpengine!rOutStream::flush_internal+0x194</span><br><span class="line">03 0019d360 79d4ce14     mpengine!rOutStream::flush+0x55</span><br><span class="line">04 0019d390 79d4cba0     mpengine!OnTheFly+0x23a</span><br><span class="line">05 0019d3c8 79c84cf8     mpengine!runpack+0x7c</span><br><span class="line">06 0019d45c 79c78bef     mpengine!Decompress+0x69</span><br><span class="line">07 0019d488 79c788f1     mpengine!CAsprotectDLLAndVersion::Unpack+0x7a</span><br><span class="line">08 0019d5f0 79d33b90     mpengine!CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects+0x365</span><br><span class="line">09 0019d624 79d32df4     mpengine!AsprotectIsMine+0x60</span><br><span class="line">0a 0019d6a4 79d3276a     mpengine!UnpackerContext::Unpack+0xb9</span><br><span class="line">0b 0019d774 79d19397     mpengine!HandleUnpacker+0x23a</span><br><span class="line">0c 0019d8a8 79d18a96     mpengine!kvscanpage4sig+0x7f8</span><br><span class="line">0d 0019d8e0 79d1dad3     mpengine!kvscan4sig+0xb3</span><br><span class="line">0e 0019d918 79b6e305     mpengine!scan_x32_context::jmp_scan+0x33</span><br><span class="line">0f 0019d98c 79b716df     mpengine!DTscan_worker&lt;0&gt;+0x1c5</span><br><span class="line">10 0019da20 79d19d48     mpengine!DTscan+0xe2</span><br><span class="line">11 0019db50 79d1a231     mpengine!scan_pe_dtscan_slice+0xaa</span><br><span class="line">12 0019ddf4 79c1134f     mpengine!scan_pe_dtscan+0xe1</span><br><span class="line">13 0019df9c 79b84a5d     mpengine!pefile_scan_mp+0x171d</span><br><span class="line">14 0019dfb0 79b82ce0     mpengine!UfsScannerWrapper::ScanFile+0x4e</span><br><span class="line">15 0019f280 79ba3418     mpengine!UfsClientRequest::fscan+0x4bb</span><br><span class="line">16 0019f304 79ba2e56     mpengine!UfsNode::ScanLoopHelper+0xf4</span><br><span class="line">17 0019f338 79c2c9b9     mpengine!UfsNode::Analyze+0x14f</span><br><span class="line">18 0019f3a0 79c32b7a     mpengine!UfsClientRequest::AnalyzeLeaf+0xa2</span><br><span class="line">19 0019f414 7a1ea7dc     mpengine!UfsClientRequest::AnalyzePath+0x12f</span><br><span class="line">1a 0019f480 7a1ea8eb     mpengine!UfsCmdBase::ExecuteCmd&lt;&lt;lambda_c80a88e180c1f4524a759d69aa15f87e&gt; &gt;+0x1ee</span><br><span class="line">1b 0019f6d4 79f469dc     mpengine!UfsScanFolderCmd::Execute+0x5b</span><br><span class="line">1c 0019fa9c 79c2b48a     mpengine!ksignal+0x31b50c</span><br><span class="line">1d 0019fac0 79c2b310     mpengine!DispatchSignalHelper+0x4e</span><br><span class="line">1e 0019fd68 79c2b25e     mpengine!DispatchSignalOnHandle+0x93</span><br><span class="line">1f 0019fd78 79c2b1b2     mpengine!__rsignal+0x2e</span><br><span class="line">20 0019fd9c 00401422     mpengine!rsignal+0x32</span><br></pre></td></tr></table></figure>

<p>ohhhhhhhhhhhhhhhhhhhhhhhh&#xFF01;</p>
<p>&#x4F7F;&#x7528;windbg_preview&#x7684;<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/time-travel-debugging-overview" target="_blank" rel="noopener">TTD</a>&#x9009;&#x9879;&#xFF0C;&#x5728;&#x672C;&#x5730;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x65F6;&#x95F4;&#x70B9;&#x7D22;&#x5F15;&#x7684;dump&#x6587;&#x4EF6;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dx -r1 @$curprocess.TTD.Events</span><br></pre></td></tr></table></figure>

<p>&#x4F7F;&#x7528;&#x4E0A;&#x9762;&#x7684;&#x547D;&#x4EE4;&#x5217;&#x51FA;&#x6240;&#x6709;exception&#x4E8B;&#x4EF6;&#xFF0C;&#x627E;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x8BBF;&#x95EE;&#x5F02;&#x5E38;&#x5373;&#x53EF;&#x53CC;&#x5411;&#x6B63;&#x5E38;&#x8C03;&#x8BD5;&#x3002;</p>
<p>&#x9996;&#x5148;&#x67E5;&#x770B;memcpy&#x51FD;&#x6570;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/11.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/12.png" alt="img"></p>
<p>!heap&#x67E5;&#x770B;&#x76EE;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x7533;&#x8BF7;&#x5927;&#x5C0F;&#x4E3A;0x2000&#xFF0C;&#x5E76;&#x4E14;&#x7533;&#x8BF7;&#x4F4D;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="/2021/01/28/20210128-1/13.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/14.png" alt="img"></p>
<p>&#x5728;CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects&#x51FD;&#x6570;&#x4E2D;&#x8C03;&#x7528;malloc&#x51FD;&#x6570;&#x8FDB;&#x884C;0x2000&#x5927;&#x5C0F;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#xFF0C;&#x800C;&#x540E;&#x4F7F;&#x7528;memset&#x521D;&#x59CB;&#x5316;&#x5185;&#x5B58;&#x5730;&#x5740;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/15.png" alt="img"></p>
<p>&#x540E;&#x7EED; &#x5FAA;&#x73AF;&#x8C03;&#x7528;CAsprotectDLLAndVersion::Unpack(ulong,ulong,ulong,uchar *,ulong)</p>
<p>&#x4F20;&#x5165;&#x7684;&#x7B2C;&#x4E94;&#x53C2;&#x6570;&#xFF0C;&#x4E3A;&#x524D;&#x9762;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x52A0;&#x4E0A;offset&#x504F;&#x79FB;</p>
<p><img src="/2021/01/28/20210128-1/16.png" alt="img"></p>
<p>&#x6CE8;&#x610F;&#xFF0C;edi&#x4E3A;CAsprotectDLLAndVersion <em>this &#x5373;CAsprotectDLLAndVersion &#x7C7B;&#x5BF9;&#x8C61;&#x5730;&#x5740;&#xFF0C;&#x504F;&#x79FB;0x38&#x5904;&#x5B58;&#x50A8;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x7533;&#x8BF7;&#x7684;0x2000&#x5927;&#x5C0F;&#x5185;&#x5B58;&#xFF0C;&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#xFF08;&#x5171;4&#x6B21;&#xFF09;&#x5206;&#x522B;&#x53D6;&#x51FA;&#x504F;&#x79FB;&#x4E3A;0x10+8</em>ecx&#x4E2D;&#x7684;&#x504F;&#x79FB;&#x503C;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/17.png" alt="img"></p>
<p>&#x6B64;&#x5904;&#x5E03;&#x5C40;&#x6211;&#x4EEC;&#x540E;&#x7EED;&#x4F1A;&#x63D0;&#x5230;&#x662F;&#x5982;&#x4F55;&#x5F62;&#x6210;&#x7684;&#x3002;</p>
<p>&#x7B2C;&#x516D;&#x53C2;&#x6570;[edi+ecx*8+14h] = 0</p>
<p>&#x7B2C;&#x4E94;&#x53C2;&#x6570;&#x6BD4;&#x8F83;&#x7279;&#x6B8A;&#xFF1A;</p>
<p><u>&#x524D;&#x4E24;&#x6B21;&#x53D6;&#x51FA;&#x504F;&#x79FB;&#x503C;&#x4E3A;&#x96F6;&#xFF0C;&#x6240;&#x4EE5;&#x540E;&#x7EED;&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#x4E3A;&#x7533;&#x8BF7;&#x7684;&#x5730;&#x5740;0x2b883000&#xFF0C;</u></p>
<p><u>&#x7B2C;&#x4E09;&#x6B21;&#x53D6;&#x51FA;&#x503C;&#x4E3A;0x2000&#xFF0C;&#x5219;&#x540E;&#x7EED;&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#x4E3A;&#x7533;&#x8BF7;&#x5230;&#x7684;&#x5730;&#x5740;0x2b883000+0x2000&#x5373;0x2b885000</u></p>
<p><u>&#x7B2C;&#x56DB;&#x6B21;&#x53D6;&#x51FA;&#x503C;&#x4E3A;0x2000&#xFF0C;&#x5219;&#x540E;&#x7EED;&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#x4E3A;&#x7533;&#x8BF7;&#x5230;&#x7684;&#x5730;&#x5740;0x2b883000+0x2000&#x5373;0x2b885000</u></p>
<p><strong>&#x800C;&#x5D29;&#x6E83;&#x5C31;&#x53D1;&#x751F;&#x5728;&#x7B2C;&#x56DB;&#x6B21;&#x5FAA;&#x73AF;</strong></p>
<p>&#x7B2C;&#x56DB;&#x53C2;&#x6570;&#x4F20;&#x5165;edi+14&#x5730;&#x5740;&#x5904;&#x503C;&#x4E3A;0</p>
<p>&#x7B2C;&#x4E09;&#x53C2;&#x6570;[ebp+ecx<em>4-0D8h] = 0,&#x7B2C;&#x4E8C;&#x53C2;&#x6570;[edi+3c]+[edi+ecx</em>8+10h] = 0x42b040&#xFF0C;&#x7B2C;&#x4E00;&#x53C2;&#x6570;this</p>
<p><strong>&#x6CE8;&#x610F;&#x4E0B;&#x9762;&#x6709;&#x51E0;&#x4E2A;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#xFF0C;&#x8FD9;&#x91CC;&#x5355;&#x72EC;&#x5217;&#x51FA;&#x8BF4;&#x660E;&#x3002;</strong></p>
<p>1&#x3001;&#x5728;AsprotectIsMine&#x4E2D;&#x8C03;&#x7528;&#x7684;std::make_shared&lt;CAsprotectDLLAndVersion,std::shared_ptr<packedfileinfo> const &amp;&gt;(std::shared_ptr<packedfileinfo> const &amp;)&#x4F7F;&#x7528;new(0x19c)&#xFF08;malloc&#xFF09;&#x7533;&#x8BF7;&#x4E86;CAsprotectDLLAndVersion&#x7C7B;&#x5BF9;&#x8C61;&#x5185;&#x5B58;&#x5730;&#x5740;&#x3002;</packedfileinfo></packedfileinfo></p>
<p>&#x8BB0;&#x4E3A;t1&#xFF0C;&#x5728;TTD&#x4E2D;&#x9996;&#x5730;&#x5740;&#x4E3A;0x3254c260&#x3002;</p>
<p>2&#x3001;&#x5728;CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects&#x51FD;&#x6570;&#x4E2D;&#x7B2C;&#x4E00;&#x6B21;&#x7533;&#x8BF7;&#x7684;0x500&#x5927;&#x5C0F;&#x5185;&#x5B58;&#xFF0C;&#x8BB0;&#x4E3A;dest1&#xFF0C;&#x5728;TTD&#x4E2D;&#x9996;&#x5730;&#x5740;&#x4E3A;0x32cc96b0&#x3002;</p>
<p>3&#x3001;&#x5728;&#x975E;&#x5FAA;&#x73AF;&#x7684;CAsprotectDLLAndVersion::Unpack&#x51FD;&#x6570;&#x7684;&#x540E;&#x7EED;&#x6267;&#x884C;&#x4E2D;&#xFF0C;FlyInit&#x7533;&#x8BF7;&#x7684;0x1000&#x5927;&#x5C0F;&#x5185;&#x5B58;&#xFF0C;&#x8BB0;&#x4E3A;s1 &#xFF0C;&#x5728;TTD&#x4E2D;&#x9996;&#x5730;&#x5740;&#x4E3A;0x32b8bca8&#x3002;</p>
<p>4&#x3001;&#x5728;CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects&#x51FD;&#x6570;&#x4E2D;&#x7B2C;&#x4E8C;&#x6B21;&#x7533;&#x8BF7;&#x7684;0x2000&#x5927;&#x5C0F;&#x5185;&#x5B58;&#xFF0C;&#x8BB0;&#x4E3A;dest2&#xFF0C;&#x5728;TTD&#x4E2D;&#x9996;&#x5730;&#x5740;&#x4E3A;0x2b883000 &#x3002;</p>
<p>5&#x3001;&#x5728;&#x5FAA;&#x73AF;&#x7684;CAsprotectDLLAndVersion::Unpack&#x51FD;&#x6570;&#x7684;&#x540E;&#x7EED;&#x6267;&#x884C;&#x4E2D;&#xFF0C;FlyInit&#x7533;&#x8BF7;&#x7684;0x3000&#x5927;&#x5C0F;&#x5185;&#x5B58;&#xFF0C;&#x8BB0;&#x4E3A;m2 &#xFF0C;&#x5728;TTD&#x4E2D;&#x9996;&#x5730;&#x5740;&#x4E3A;0x3149c320 &#x3002;</p>
<p>&#x4E0B;&#x9762;&#x8FDB;&#x5165;CAsprotectDLLAndVersion::Unpack&#x51FD;&#x6570;&#xFF0C;&#x6B64;&#x65F6;&#x4E3A;&#x7B2C;&#x4E00;&#x6B21;&#x975E;&#x5FAA;&#x73AF;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/18.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/19.png" alt="img"></p>
<p>malloc(0)&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6307;&#x9488;0x3254c438</p>
<p><img src="/2021/01/28/20210128-1/20.png" alt="img"></p>
<p>&#x9996;&#x5148;PtrType&#x6784;&#x9020;&#x51FD;&#x6570;&#x521D;&#x59CB;&#x5316;PtrType&#x5BF9;&#x8C61;&#xFF0C;</p>
<p><img src="/2021/01/28/20210128-1/21.png" alt="img"></p>
<p>&#x6700;&#x7EC8;&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x5982;&#x4E0B;</p>
<p><img src="/2021/01/28/20210128-1/22.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/23.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/24.png" alt="img"></p>
<p>&#x8FDB;&#x5165;CAsprotectDLLAndVersion::ReadPackedFile&#x51FD;&#x6570;&#xFF0C;&#x4E09;&#x53C2;&#x6570;&#xFF0C;&#x7B2C;&#x4E00;&#x53C2;&#x6570;&#x5C40;&#x90E8;&#x53D8;&#x91CF;[esp+20h+var_8] =0x3254c26c &#x3002; </p>
<p>&#x4E3A;CAsprotectDLLAndVersion &#x7C7B;&#x5BF9;&#x8C61;&#x5730;&#x5740;&#xFF0C;&#x7B2C;&#x4E8C;&#x53C2;&#x6570;malloc(0)&#x6307;&#x9488;0x3254c438&#xFF0C;&#x7B2C;&#x4E09;&#x53C2;&#x6570;a3=[ebp+ecx*4-0D8h] = 0&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/25.png" alt="img"></p>
<p>&#x7ECF;&#x8FC7;&#x56DE;&#x6EAF;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x6B64;&#x5904;&#x7684;t1&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x4E3A;CAsprotectDLLAndVersion::CAsprotectDLLAndVersion(class std::shared_ptr<struct packedfileinfo> const &amp;)&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x3002;</struct></p>
<p><img src="/2021/01/28/20210128-1/26.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/27.png" alt="img"></p>
<p>&#x8FDB;&#x5165;&#x5230;CAsprotectDLLAndVersion::CAsprotectDLLAndVersion&#x51FD;&#x6570;</p>
<p><img src="/2021/01/28/20210128-1/28.png" alt="img"></p>
<p>ecx&#x6B63;&#x662F;t1+0c = 0x3254c260+Ch = 0x3254c26c</p>
<p><img src="/2021/01/28/20210128-1/29.png" alt="img"></p>
<p>&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#x9996;&#x5148;&#x521D;&#x59CB;&#x5316;&#x90E8;&#x5206;&#x4F4D;&#x7F6E;&#x5185;&#x5B58;&#x4E3A;0&#xFF0C;edx&#x53D6;&#x51FA;&#x4F20;&#x5165;&#x53C2;&#x6570;[ebp+8]&#x7684;&#x503C;&#xFF0C;&#x586B;&#x5145; [edx]=0x2cd94944  [edx+4] = 0x2cd94938</p>
<p><img src="/2021/01/28/20210128-1/30.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/31.png" alt="img"></p>
<p>&#x518D;&#x6B21;&#x7528;&#x6B64;&#x503C;&#x521D;&#x59CB;&#x5316;[ecx+30],[ecx+34],&#x540C;&#x65F6;&#x7528;esi=0&#x521D;&#x59CB;&#x5316;[ecx+38h],[ecx+40h],[ecx+44h]&#xFF0C;[ecx+4ch]</p>
<p><img src="/2021/01/28/20210128-1/32.png" alt="img"></p>
<p>&#x7B80;&#x5355;&#x6EAF;&#x6E90;&#x4E00;&#x4E0B;&#x8FD9;&#x4E24;&#x4E2A;&#x503C;&#x7684;&#x6765;&#x6E90;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">CAsprotectDLLAndVersion::CAsprotectDLLAndVersion&#x4E0A;&#x5C42;&#x51FD;&#x6570;</span><br><span class="line"></span><br><span class="line">std::make_shared&lt;class CAsprotectDLLAndVersion, class std::shared_ptr&lt;struct PackedFileInfo&gt; const &amp;&gt;(class std::shared_ptr&lt;struct PackedFileInfo&gt; const &amp;)</span><br><span class="line">mov     edi, edx</span><br><span class="line">push    edi////&#x4F20;&#x5165;UnpackerContext&#x6307;&#x9488;+0x10</span><br><span class="line">call    CAsprotectDLLAndVersion::CAsprotectDLLAndVersion</span><br><span class="line"></span><br><span class="line">&#x4E0A;&#x5C42;&#x51FD;&#x6570; AsprotectIsMine</span><br><span class="line">mov     ebx, [ebp+arg_4]//+C </span><br><span class="line">...</span><br><span class="line">mov     edx, ebx////&#x4F20;&#x5165;UnpackerContext&#x6307;&#x9488;+0x10</span><br><span class="line">lea     ecx, [ebp+var_18]</span><br><span class="line">call    std::make_shared&lt;class CAsprotectDLLAndVersion, class std::shared_ptr&lt;struct PackedFileInfo&gt; const &amp;&gt;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#x4E0A;&#x5C42;&#x51FD;&#x6570;UnpackerContext::Unpack</span><br><span class="line"></span><br><span class="line">call    PEFileReader::LooksLikePEFile(FileReader const *)//!</span><br><span class="line"></span><br><span class="line">mov     edi, ecx//UnpackerContext&#x6307;&#x9488;+C</span><br><span class="line">lea     eax, [edi+4]</span><br><span class="line">lea     ecx, [ebp+var_3C]</span><br><span class="line">push    eax</span><br><span class="line">call    std::shared_ptr&lt;class UnpackerContext&gt;::shared_ptr&lt;class UnpackerContext&gt;(class std::weak_ptr&lt;class UnpackerContext&gt; const &amp;)</span><br><span class="line">//&#x6B64;&#x51FD;&#x6570;&#x4E2D;</span><br><span class="line">        mov     esi, ecx</span><br><span class="line">        mov     edi, [ebp+arg_0]</span><br><span class="line">        mov     eax, [edi]</span><br><span class="line">        mov     [esi], eax</span><br><span class="line">        mov     eax, [edi+4]</span><br><span class="line">        mov     [esi+4], eax</span><br><span class="line">    </span><br><span class="line">mov     eax, [ebp+var_3C] //&#x6B64;&#x65F6;&#x6B64;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5904;&#x5185;&#x5B58;&#x88AB;&#x8986;&#x76D6;&#x4E3A;UnpackerContext&#x6307;&#x9488;+C+4&#x5373;UnpackerContext&#x6307;&#x9488;+0x10  UnpackerContext&#x6307;&#x9488;+C+4+4&#x5373;UnpackerContext&#x6307;&#x9488;+0x14&#x5904;&#x7684;&#x503C;</span><br><span class="line"></span><br><span class="line">0:000&gt; dd edi-c</span><br><span class="line">2cd94938  798d6d6c 00000002 00000002 798d6dd4</span><br><span class="line">2cd94948  2cd94944 2cd94938 e0e0e000 2778c1c0</span><br><span class="line">2cd94958  2cd94a54 2cd94a48 31cfc9a4 31cfc998</span><br><span class="line">2cd94968  325b7958 325b7948 00000000 00000000</span><br><span class="line">2cd94978  00000000 00000000 798d6d9c 29d0e000</span><br><span class="line">2cd94988  798d6d90 2778c1c0 798d6d80 2778c1c0</span><br><span class="line">2cd94998  00000000 00000000 00000000 00000000</span><br><span class="line">2cd949a8  00000000 00000000 00000000 00000000</span><br><span class="line">0:000&gt; dd ebp-3c</span><br><span class="line">0019d668  2cd94944 2cd94938 325b796c 325b7ae0</span><br><span class="line"></span><br><span class="line">mov     [ebp+var_44], eax</span><br><span class="line">lea     eax, [ebp+var_44]</span><br><span class="line">push    eax</span><br><span class="line">0:000&gt; dd ebp-44</span><br><span class="line">0019d660  2cd94944 2cd94938 00000000 00000000</span><br><span class="line">lea     eax, [ebp+var_20]</span><br><span class="line">push    eax</span><br><span class="line">call    AsprotectIsMine//&#x4F20;&#x5165;UnpackerContext&#x6307;&#x9488;+0x10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x4E0A;&#x5C42;&#x51FD;&#x6570; HandleUnpacker</span><br><span class="line">push    0Ch</span><br><span class="line">call    mpengine!operator new (79b93d7c)//&#x7533;&#x8BF7;c&#x5927;&#x5C0F;&#x5185;&#x5B58;</span><br><span class="line">mov     edi, eax</span><br><span class="line">mov     [ebp+var_A8], edi</span><br><span class="line">lea     esi, [edi+4]</span><br><span class="line"></span><br><span class="line">push    0D4h</span><br><span class="line">call    mpengine!operator new (79b93d7c)//&#x7533;&#x8BF7;UnpackerContext&#x5BF9;&#x8C61;&#x5185;&#x5B58;</span><br><span class="line"></span><br><span class="line">//&#x8C03;&#x7528;UnpackerContext::UnpackerContext&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x521B;&#x5EFA;UnpackerContext&#x7C7B;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x5E76;&#x521D;&#x59CB;&#x5316;</span><br><span class="line">call std::_Ref_count_obj&lt;UnpackerContext&gt;::_Ref_count_obj&lt;UnpackerContext&gt;(pe_vars_t * &amp;)</span><br><span class="line"></span><br><span class="line">0:000&gt; ? eax+c</span><br><span class="line">Evaluate expression: 752437572 = 2cd94944</span><br><span class="line">0:000&gt; dd eax</span><br><span class="line">2cd94938  798d6d6c 00000001 00000001 798d6dd4</span><br><span class="line">2cd94948  00000000 00000000 e0e0e000 2778c1c0</span><br><span class="line">2cd94958  2cd94a54 2cd94a48 31cfc9a4 31cfc998</span><br><span class="line">2cd94968  325b7958 325b7948 00000000 00000000</span><br><span class="line">2cd94978  00000000 00000000 798d6d9c 29d0e000</span><br><span class="line">2cd94988  798d6d90 2778c1c0 798d6d80 2778c1c0</span><br><span class="line">2cd94998  00000000 00000000 00000000 00000000</span><br><span class="line">2cd949a8  00000000 00000000 00000000 00000000</span><br><span class="line"></span><br><span class="line">mov     [esi+4], eax//&#x4F20;&#x5165;UnpackerContext&#x6307;&#x9488;</span><br><span class="line">lea     edx, [eax+0Ch]</span><br><span class="line">mov     [esi], edx//&#x4F20;&#x5165;UnpackerContext&#x6307;&#x9488;+C&#x5730;&#x5740;</span><br><span class="line"></span><br><span class="line">0:000&gt; dd esi</span><br><span class="line">318ec90c  2cd94944 2cd94938 a0a0a0a0 a0a0a0a0</span><br><span class="line">318ec91c  a0a0a0a0 00000000 00000000 285bfff4</span><br><span class="line">318ec92c  14aefe7c abcdaaaa 950c1000 00000054</span><br><span class="line">318ec93c  0000007c 38db6ba8 318ecc10 14222454</span><br><span class="line">318ec94c  dcbaaaaa 5a400000 1f192500 000015d0</span><br><span class="line">318ec95c  00000000 00000000 00000007 38db6bb8</span><br><span class="line">318ec96c  e0e0e0e0 e0e0e0e0 e0e0e0e0 00000038</span><br><span class="line">318ec97c  0000003f 40400000 40647473 45415140</span><br><span class="line"> </span><br><span class="line">mov     esi, dword ptr [ebp-0A8h]</span><br><span class="line">mov     ecx, [esi+4]//UnpackerContext&#x6307;&#x9488;+C</span><br><span class="line">call    UnpackerContext::Unpack</span><br></pre></td></tr></table></figure>

<p>&#x503C;&#x5F97;&#x4E00;&#x63D0;&#x7684;&#x662F;&#xFF0C;&#x5728;UnpackerContext::Unpack&#x51FD;&#x6570;&#x4E2D;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x51FD;&#x6570;PEFileReader::LooksLikePEFile&#xFF0C;&#x4F5C;&#x4E3A;WinDefender&#x7684;&#x91CD;&#x8981;&#x6A21;&#x5757;&#xFF0C;&#x6A21;&#x62DF;&#x5668;&#x4F5C;&#x4E3A;&#x91CD;&#x8981;&#x529F;&#x80FD;&#xFF0C;&#x800C;&#x6B64;&#x51FD;&#x6570;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;PE&#x5934;&#x89E3;&#x6790;&#x81EA;&#x7136;&#x4E5F;&#x662F;&#x91CD;&#x4E2D;&#x4E4B;&#x91CD;&#x3002;&#x7B80;&#x5355;&#x89E3;&#x6790;&#x540E;&#x53D1;&#x73B0;&#xFF0C;&#x6B64;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x8BFB;&#x53D6;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;PE&#x89E3;&#x6790;&#x3002;&#x4F46;&#x9759;&#x6001;&#x5206;&#x6790;&#x6765;&#x770B;&#xFF0C;&#x5176;&#x884C;&#x4E3A;&#x4E0E;&#x5F53;&#x524D;&#x6F0F;&#x6D1E;&#x65E0;&#x5173;&#xFF0C;&#x6545;&#x4EC5;&#x505A;&#x7F57;&#x5217;&#x3002;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x5411;&#x4E0B;&#xFF0C;&#x56DE;&#x5230;&#x6211;&#x4EEC;&#x7684;CAsprotectDLLAndVersion::CAsprotectDLLAndVersion&#x51FD;&#x6570;&#xFF0C;&#x6784;&#x9020;&#x51FD;&#x6570;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x8FD4;&#x56DE;&#x3002;t1&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ecx-c</span><br><span class="line">3254c260  798d93e0 00000001 00000001 00000000</span><br><span class="line">3254c270  00000000 00000000 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c280  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c290  e0e0e0e0 e0e0e0e0 e0e0e0e0 2cd94944</span><br><span class="line">3254c2a0  2cd94938 00000000 e0e0e0e0 00000000</span><br><span class="line">3254c2b0  00000000 e0e0e0e0 00000000 e0e0e0e0</span><br><span class="line">3254c2c0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c2d0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line"></span><br><span class="line">mov     [ebx], ecx</span><br></pre></td></tr></table></figure>

<p>&#x8FD4;&#x56DE;AsprotectIsMine&#xFF0C;&#x8C03;&#x7528;CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects&#x51FD;&#x6570;</p>
<p><img src="/2021/01/28/20210128-1/33.png" alt="img"></p>
<p>&#x6B64;&#x51FD;&#x6570;&#x4E2D;&#x9996;&#x5148;&#x4E24;&#x6B21;&#x8C03;&#x7528;CAsprotectDLLAndVersion::Read&#x51FD;&#x6570;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/34.png" alt="img"></p>
<p>&#x591A;&#x6B21;&#x91CD;&#x8F7D;[thunk]:PEFileReader::ReadMemory`vtordisp</p>
<p><img src="/2021/01/28/20210128-1/35.png" alt="img"></p>
<p>PEFileReader::ReadMemory(class PtrType const &amp;, void *, unsigned int)const</p>
<p><img src="/2021/01/28/20210128-1/36.png" alt="img"></p>
<p>PEEmulatorAdaptor::ReadMemory</p>
<p><img src="/2021/01/28/20210128-1/37.png" alt="img"></p>
<p>&#x4F7F;&#x7528;pem_read_buffer&#x51FD;&#x6570;</p>
<p><img src="/2021/01/28/20210128-1/38.png" alt="img"></p>
<p>&#x8C03;&#x8BD5;&#x540E;&#x53D1;&#x73B0;&#xFF0C;pem_read_buffer&#x51FD;&#x6570;&#x5E76;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x6267;&#x884C;&#xFF0C;&#x800C;&#x662F;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;a1==0&#xFF0C;&#x8FD4;&#x56DE;&#x5230;CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects&#x51FD;&#x6570;&#x4E2D;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;malloc&#x51FD;&#x6570;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;malloc&#x5927;&#x5C0F;&#x4E3A;0x500&#xFF0C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x4E3A;dest1 = 0x32cc96b0&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/39.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ebx</span><br><span class="line">00000500  ???????? ???????? ???????? ????????</span><br></pre></td></tr></table></figure>

<p>&#x63A5;&#x7740;&#x8C03;&#x7528;&#x975E;&#x5FAA;&#x73AF;&#x7684;CAsprotectDLLAndVersion::Unpack&#x51FD;&#x6570;&#x3002;</p>
<p>&#x6B64;&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x9700;&#x8981;&#x641E;&#x6E05;&#x695A;&#xFF0C;&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6E90;&#x5730;&#x5740;s1&#x7684;&#x6765;&#x6E90;&#x548C;&#x5E03;&#x5C40;&#x8FC7;&#x7A0B;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x5185;&#x5B58;&#x65AD;&#x70B9;&#xFF0C;&#x5F97;&#x5230;s1&#x7684;&#x5E03;&#x5C40;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;&#x6808;&#x56DE;&#x6EAF;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; k</span><br><span class="line"> # ChildEBP RetAddr      </span><br><span class="line">00 0019d2f8 79cce19a     mpengine!memcpy+0x4e</span><br><span class="line">01 0019d314 79d4f642     mpengine!UnplibMemwrite::Write+0x2a</span><br><span class="line">02 0019d340 79d4f455     mpengine!rOutStream::flush_internal+0x194</span><br><span class="line">03 0019d360 79d4cca2     mpengine!rOutStream::flush+0x55</span><br><span class="line">04 0019d390 79d4cba0     mpengine!OnTheFly+0xc8</span><br><span class="line">05 0019d3c8 79c84cf8     mpengine!runpack+0x7c</span><br><span class="line">06 0019d45c 79c78bef     mpengine!Decompress+0x69</span><br><span class="line">07 0019d488 79c786e0     mpengine!CAsprotectDLLAndVersion::Unpack+0x7a</span><br><span class="line">08 0019d5f0 79d33b90     mpengine!CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects+0x154</span><br><span class="line">09 0019d624 79d32df4     mpengine!AsprotectIsMine+0x60</span><br><span class="line">0a 0019d6a4 79d3276a     mpengine!UnpackerContext::Unpack+0xb9</span><br><span class="line">0b 0019d774 79d19397     mpengine!HandleUnpacker+0x23a</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">mpengine!UnplibMemwrite::Write+0x25:</span><br><span class="line">79cce195 e8162d1200      call    mpengine!memcpy (79df0eb0)</span><br><span class="line">0:000&gt; dd eax</span><br><span class="line">32cc96b0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc96c0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0 </span><br><span class="line"></span><br><span class="line">0:000&gt; dd poi(ebp+8)</span><br><span class="line">32b8bca8  6134858d c350001f 90909d8b db0b9090</span><br><span class="line">32b8bcb8  038b9074 90908587 03899090 61c0b58d</span><br><span class="line">32b8bcc8  3e83001f 90840f00 8d000000 909090b5</span><br><span class="line"></span><br><span class="line">0:000&gt; dd edi</span><br><span class="line">00000469</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/28/20210128-1/40.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpengine!UnplibMemwrite::Write&#x51FD;&#x6570;&#x4E2D;&#x8C03;&#x7528;&#x62F7;&#x8D1D;&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x62F7;&#x8D1D;&#x3002;&#x6B64;&#x65F6;&#x7684;&#x76EE;&#x7684;&#x5730;&#x5740;&#x4E3A;dest1,&#x800C;&#x6E90;&#x5730;&#x5740;s1&#x7684;&#x6765;&#x6E90;&#x5982;&#x4E0B;&#xFF1A;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/28/20210128-1/41.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/42.png" alt="img"></p>
<p>Decompress-&gt;runpack-&gt;FlyInit-&gt;malloc&#x7533;&#x8BF7;0xA0&#x5927;&#x5C0F;&#xFF0C;&#x8FD4;&#x56DE;&#x503C;&#x4E3A;s1&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/43.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/44.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/45.png" alt="img"></p>
<p>s1&#x521D;&#x59CB;&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd eax</span><br><span class="line">32b8bca8  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32b8bcb8  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32b8bcc8  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32b8bcd8  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32b8bce8  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32b8bcf8  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32b8bd08  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32b8bd18  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/28/20210128-1/46.png" alt="img"></p>
<p>FlyInit&#x8FD4;&#x56DE;&#x540E;&#xFF0C;&#x8C03;&#x7528;OnTheFly&#x51FD;&#x6570;&#x3002;&#x7ECF;&#x8FC7;&#x4EE5;&#x4E0A;&#x6D41;&#x7A0B;&#xFF0C;&#x5728;APLib::OnTheFly&#x51FD;&#x6570;&#x4E2D;&#x6B7B;&#x5FAA;&#x73AF;&#xFF0C;mpengine!rInStream::getByte&#x83B7;&#x53D6;Byte&#x503C;&#xFF0C;&#x5E76;&#x586B;&#x5145;&#x81F3;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;s1&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/47.png" alt="img"></p>
<p>s1&#x6B64;&#x65F6;&#x7684;&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x5982;&#x56FE;&#xFF0C;&#x6CE8;&#x610F;&#x6B64;&#x65F6;s1+8c&#x5904;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x6B63;&#x662F;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;&#x91CD;&#x8981;&#x5E03;&#x5C40;&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x8FD8;&#x6700;&#x7EC8;&#x771F;&#x6B63;&#x9700;&#x8981;&#x7684;&#x76EE;&#x6807;&#x5730;&#x5740;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mpengine!UnplibMemwrite::Write+0x25:</span><br><span class="line">79cce195 e8162d1200      call    mpengine!memcpy (79df0eb0)</span><br><span class="line">0:000&gt; dd eax                                    //edi</span><br><span class="line">32cc96b0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc96c0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc96d0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc96e0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc96f0  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc9700  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc9710  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">32cc9720  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">0:000&gt; dd poi(ebp+8)                            //esi</span><br><span class="line">32b8bca8  6134858d c350001f 90909d8b db0b9090</span><br><span class="line">32b8bcb8  038b9074 90908587 03899090 61c0b58d</span><br><span class="line">32b8bcc8  3e83001f 90840f00 8d000000 909090b5</span><br><span class="line">32b8bcd8  04468b90 0068046a 50000010 95ff006a</span><br><span class="line">32b8bce8  90909090 90908589 8b569090 909d031e</span><br><span class="line">32b8bcf8  50909090 9090e853 bd800090 90909090</span><br><span class="line">32b8bd08  fe907500 90909085 033e8b90 909090bd</span><br><span class="line">32b8bd18  c637ff90 d7ffc307 5150078f c88b5356</span><br><span class="line">0:000&gt; dd edi</span><br><span class="line">00000469  ???????? ???????? ???????? ???????? //size</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/28/20210128-1/48.png" alt="img"></p>
<p>s1&#x5E03;&#x5C40;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x7ECF;&#x8FC7;&#x4E0A;&#x8FF0;&#x6D41;&#x7A0B;&#x5C06;s1 = 0x32b8bca8&#x5904;&#x5185;&#x5B58;&#x62F7;&#x8D1D;&#x5230;dest1 = 0x32cc96b0&#x5904;&#xFF0C;&#x8FD4;&#x56DE;&#x3002;&#x975E;&#x5FAA;&#x73AF;&#x7684;CAsprotectDLLAndVersion::Unpack&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x540E;&#xFF0C;CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects&#x51FD;&#x6570;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;</p>
<p>&#x9996;&#x5148;&#x8FDB;&#x884C;&#x4E00;&#x6B21;&#x62F7;&#x8D1D;&#x5DE5;&#x4F5C;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/49.png" alt="img"></p>
<p>&#x8FD9;&#x91CC;&#x7684;memcpy&#x64CD;&#x4F5C;&#xFF0C;&#x5C06;dest1+8c&#x5904;&#x5185;&#x5B58;&#x62F7;&#x8D1D;&#x81F3;t1+8c&#xFF0C;&#x5171;0x20&#x5B57;&#x8282;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd esi</span><br><span class="line">32cc973c  00000000 00000000 00000000 00000000</span><br><span class="line">32cc974c  00002000 00000000 00002000 00003000</span><br><span class="line">32cc975c  ffffffff ffffffff ffffffff ffffffff</span><br><span class="line">32cc976c  ffffffff ffffffff ffffffff ffffffff</span><br><span class="line">32cc977c  ffffffff ffffffff ffffffff ffffffff</span><br><span class="line">32cc978c  ffffffff ffffffff ffffffff ffffffff</span><br><span class="line">32cc979c  ffffffff ffffffff ffffffff ffffffff</span><br><span class="line">32cc97ac  ffffffff ffffffff ffffffff ffffffff</span><br><span class="line">0:000&gt; dd edi</span><br><span class="line">3254c27c  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c28c  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c29c  2cd94944 2cd94938 00000000 0042b040</span><br><span class="line">3254c2ac  00000000 00000000 e0e0e0e0 00000000</span><br><span class="line">3254c2bc  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c2cc  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c2dc  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c2ec  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br></pre></td></tr></table></figure>

<p>&#x62F7;&#x8D1D;&#x5B8C;&#x6210;&#x540E;&#xFF0C;t1+8c&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd 3254c27c</span><br><span class="line">3254c27c  00000000 00000000 00000000 00000000</span><br><span class="line">3254c28c  00002000 00000000 00002000 00003000</span><br><span class="line">3254c29c  2cd94944 2cd94938 00000000 0042b040</span><br><span class="line">3254c2ac  00000000 00000000 e0e0e0e0 00000000</span><br><span class="line">3254c2bc  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c2cc  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c2dc  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3254c2ec  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;<strong>&#x91CD;&#x8981;&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x5B8C;&#x6210;</strong>&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;Size&#x7684;&#x6765;&#x6E90;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;&#x7684;&#x3002;&#x8BA1;&#x7B97;&#x65B9;&#x6CD5;&#x4E3A;[&#x5916;&#x90E8;&#x4F20;&#x5165;&#x5730;&#x5740;ecx+14h-4]&#x5373;ecx+10&#x5904;&#x5730;&#x5740;&#xFF0C;&#x6B64;&#x5730;&#x5740;&#x6B63;&#x662F;&#x4E0A;&#x4E00;&#x6B65;&#x62F7;&#x8D1D;&#x5B8C;&#x6210;&#x7684;&#x5730;&#x5740;0x3254c27c&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/51.png" alt="img"></p>
<p>&#x62FF;&#x5230;0x2000&#x7684;&#x503C;&#xFF0C;&#x540E;&#x7EED;&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x7528;malloc&#x7533;&#x8BF7;&#x5927;&#x5C0F;,&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x4E3A;dest2 = 0x2b883000 &#x3002;</p>
<p>&#x63A5;&#x7740;CAsprotectDLLAndVersion::RetrieveVersionInfoAndCreateObjects&#x51FD;&#x6570;&#x5411;&#x4E0B;&#x6267;&#x884C;&#x8FDB;&#x5165;&#x5FAA;&#x73AF;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/52.png" alt="img"></p>
<p>&#x524D;&#x9762;&#x63D0;&#x5230;&#xFF0C;&#x4ECE;&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x7528;CAsprotectDLLAndVersion::Unpack&#x51FD;&#x6570;&#x5F00;&#x59CB;&#xFF0C;&#x4E3A;&#x5FAA;&#x73AF;&#x6267;&#x884C;&#xFF0C;&#x6BCF;&#x6B21;&#x552F;&#x4E00;&#x7684;&#x533A;&#x522B;&#x7684;&#x5728;&#x5FAA;&#x73AF;&#x7684;&#x7B2C;&#x4E09;&#x548C;&#x7B2C;&#x56DB;&#x6B21;&#x4F20;&#x5165;&#x7684;&#x7B2C;&#x4E94;&#x53C2;&#x6570;&#x53D8;&#x4E3A;malloc(0x2000)&#x5730;&#x5740;+0x2000 &#x8BB0;&#x4E3A; addrx &#xFF0C;&#x53EF;&#x80FD;&#x7B49;&#x4E8E;dest2&#xFF0C;&#x4E5F;&#x53EF;&#x80FD;&#x7B49;&#x4E8E;dest2+0x2000&#xFF0C;&#x63A5;&#x7740;&#x8C03;&#x7528;Decompress&#x51FD;&#x6570;</p>
<p>&#x8FDB;&#x5165;Decompress&#x51FD;&#x6570;&#xFF0C;UnplibMemread::UnplibMemread&#x4EE5;&#x53CA;UnplibMemwrite::UnplibMemwrite&#x51FD;&#x6570;&#x4F7F;&#x7528;&#x5C40;&#x90E8;&#x7F13;&#x51B2;&#x533A;Dest&#x5E76;&#x521D;&#x59CB;&#x5316;&#xFF0C;</p>
<p><img src="/2021/01/28/20210128-1/53.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/54.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/55.png" alt="img"></p>
<p>&#x540C;&#x65F6;&#x5C06;addrx&#x5199;&#x5165;Decompress&#x7684;&#x5C40;&#x90E8;&#x6570;&#x7EC4;&#x4E2D;</p>
<p><img src="/2021/01/28/20210128-1/56.png" alt="img"></p>
<p>&#x5C06;Dest&#x7F13;&#x51B2;&#x533A;&#x4F20;&#x5165;_runpack&#x51FD;&#x6570;&#x3002;</p>
<p>&#x524D;&#x4E09;&#x6B21;&#x5FAA;&#x73AF;&#x4E2D;&#xFF0C;&#x6B64;&#x7F13;&#x51B2;&#x533A;&#x5185;&#x5B58;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ecx</span><br><span class="line">0019d3e0  0019d428 00000000 00000000 00000000</span><br><span class="line">0019d3f0  00000000 00000000 0019d440 00000000</span><br><span class="line">0019d400  00000000 00000000 00000000 00000000</span><br><span class="line">0019d410  000003f2 00001003 00000000 00000000</span><br><span class="line">0019d420  00000000 2cd94990 798d7bc0 0019d3e0</span><br><span class="line">0019d430  00000000 3254c438 00000000 00000000</span><br><span class="line">0019d440  798d6724 0019d3e0 00000000 2b883000</span><br><span class="line">0019d450  00000000 00000000 79c78c7c 0019d488</span><br><span class="line">    </span><br><span class="line">0:000&gt; dd ecx</span><br><span class="line">0019d3e0  0019d428 00000000 00000000 00000000</span><br><span class="line">0019d3f0  00002000 00000000 0019d440 00000000</span><br><span class="line">0019d400  00000000 00000000 00000000 00000000</span><br><span class="line">0019d410  000003f2 00001003 00000000 00000000</span><br><span class="line">0019d420  00000000 2cd94990 798d7bc0 0019d3e0</span><br><span class="line">0019d430  00000000 2b887000 00002000 00000000</span><br><span class="line">0019d440  798d6724 0019d3e0 00000000 2b883000</span><br><span class="line">0019d450  00000000 00000000 79c78c7c 0019d488</span><br><span class="line">    </span><br><span class="line">    0:000&gt; dd ecx</span><br><span class="line">0019d3e0  0019d428 00000000 00000000 00000000</span><br><span class="line">0019d3f0  00000000 00000000 0019d440 00000000</span><br><span class="line">0019d400  00000000 00000000 00000000 00000000</span><br><span class="line">0019d410  000003f2 00001003 00000000 00000000</span><br><span class="line">0019d420  00000000 2cd94990 798d7bc0 0019d3e0</span><br><span class="line">0019d430  00000000 2ceee3d0 00000000 00000000</span><br><span class="line">0019d440  798d6724 0019d3e0 00000000 2b885000</span><br><span class="line">0019d450  00000000 00000000 79c78c7c 0019d488</span><br></pre></td></tr></table></figure>

<p>&#x5728;_runpack&#x4E2D;&#xFF0C;&#x5224;&#x65AD;&#x4E86;&#x6B64;&#x7F13;&#x51B2;&#x533A;&#x7684;(esi = ecx)&#xFF0C;[esi+38h],[esi+10h],[esi+14h],[esi+28h],[esi+2Ch],[esi+3Ch] &#xFF0C;&#x5F53;&#x8FD9;&#x4E9B;&#x4F4D;&#x7F6E;&#x5747;&#x4E3A;0&#x65F6;&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x540E;&#x9762;&#x7684;OnThefly&#x51FD;&#x6570;&#x3002;</p>
<p>&#x7B2C;&#x56DB;&#x6B21;&#x5FAA;&#x73AF;&#x65F6;&#x7684;&#x6B64;&#x7F13;&#x51B2;&#x533A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ecx</span><br><span class="line">0019d3e0  0019d428 00000000 00000000 00000000</span><br><span class="line">0019d3f0  00003000 00000000 0019d440 00000000</span><br><span class="line">0019d400  00000000 00000000 00003000 00000000</span><br><span class="line">0019d410  000003f2 00001003 00000000 00000000</span><br><span class="line">0019d420  00000000 2cd94990 798d7bc0 0019d3e0</span><br><span class="line">0019d430  00000000 314992e8 00003000 00000000</span><br><span class="line">0019d440  798d6724 0019d3e0 00000000 2b885000</span><br><span class="line">0019d450  00003000 00000000 79c78c7c 0019d488</span><br></pre></td></tr></table></figure>

<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;[esi+28]&#x5904;&#x7684;&#x503C;&#x4E0D;&#x4E3A;0&#xFF0C;&#x8C03;&#x7528;FlyInit&#x51FD;&#x6570;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/57.png" alt="img"></p>
<p>FlyInit&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;&#x4F7F;&#x7528;[ecx+30]&#x5904;&#x7684;&#x503C;0x3f2&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/58.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/59.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/60.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/61.png" alt="img"></p>
<p>&#x7533;&#x8BF7;&#x5185;&#x5B58;m1&#xFF0C;&#x4E3A;lzstream&#x5BF9;&#x8C61;&#xFF0C;&#x5730;&#x5740;&#x6700;&#x7EC8;&#x653E;&#x5728;ecx+0x3c&#x5904;&#xFF0C;m1 = 0x32cd7a78</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd esi</span><br><span class="line">0019d3e0  0019d428 00000000 00000000 00000000</span><br><span class="line">0019d3f0  00003000 00000000 0019d440 00000000</span><br><span class="line">0019d400  00000000 00000000 00003000 00000000</span><br><span class="line">0019d410  000003f2 00001003 00000000 32cd7a78</span><br><span class="line">0019d420  00000000 2cd94990 798d7bc0 0019d3e0</span><br><span class="line">0019d430  00000000 314992e8 00003000 00000000</span><br><span class="line">0019d440  798d6724 0019d3e0 00000000 2b885000</span><br><span class="line">0019d450  00003000 00000000 79c78c7c 0019d488</span><br><span class="line">    </span><br><span class="line"> 0:000&gt; dd 32cd7a78</span><br><span class="line">32cd7a78  798d9090 79c908e0 325ab780 e0e0e0e0</span><br><span class="line">32cd7a88  798d7c88 e0e0e0e0 79963a70 e0e0e0e0</span><br><span class="line">32cd7a98  00000000 00000000 00000000 00000000</span><br><span class="line">32cd7aa8  798d7cac 32cd7aa8 396dfa90 325ab780</span><br><span class="line">32cd7ab8  00000000 00000000 798d7c9c 32cd7ac0</span><br><span class="line">32cd7ac8  00000000 00000000 e000e000 e0e0e0e0</span><br><span class="line">32cd7ad8  00000000 e0e0e0e0 e0e0e0e0 00000000</span><br><span class="line">32cd7ae8  798d7c74 e0e0e0e0 00003000 00000000</span><br><span class="line">0:000&gt; dds 32cd7a78</span><br><span class="line">32cd7a78  798d9090 mpengine!APLib::`vftable&apos;</span><br><span class="line">32cd7a7c  79c908e0 mpengine!GetVarNumberSecondBitIsStop</span><br><span class="line">32cd7a80  325ab780</span><br><span class="line">32cd7a84  e0e0e0e0</span><br><span class="line">32cd7a88  798d7c88 mpengine!lzstream::`vftable&apos;</span><br><span class="line">32cd7a8c  e0e0e0e0</span><br></pre></td></tr></table></figure>

<p>&#x63A5;&#x7740;&#x7ECF;&#x8FC7;&#x4EE5;&#x4E0B;&#x6D41;&#x7A0B;&#x7533;&#x8BF7;&#x5230;&#x5185;&#x5B58;m2&#xFF0C;&#x5927;&#x5C0F;0x3000,m2 = 0x3149c320</p>
<p>![img](file:///C:/Users/xutianyao/Documents/My Knowledge/temp/1c7d9144-1745-464e-948d-e35e1a59ab3e/128/index_files/d88a63ea-fa01-46c3-b549-c62d5538a4b1.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd eax</span><br><span class="line">3149c320  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3149c330  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3149c340  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3149c350  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3149c360  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3149c370  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3149c380  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br><span class="line">3149c390  e0e0e0e0 e0e0e0e0 e0e0e0e0 e0e0e0e0</span><br></pre></td></tr></table></figure>

<p>ecx&#x4F20;&#x5165;OnTheFly&#x51FD;&#x6570;</p>
<p>FlyReset&#x2013;&gt;CompressMethod::Reset&#x4FEE;&#x6539;&#x4E86;0x32cd7a78&#x90E8;&#x5206;&#x5185;&#x5B58;</p>
<p><img src="/2021/01/28/20210128-1/62.png" alt="img"></p>
<p>rOutStream::is_ready&#x51FD;&#x6570;&#x5224;&#x65AD;</p>
<p>[[[0x32cd7a88]+8]+4]=0x58</p>
<p><img src="/2021/01/28/20210128-1/63.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ecx</span><br><span class="line">32cd7a88  798d7c88 e0e0e0e0 79963a70 e0e0e0e0</span><br><span class="line">0:000&gt; dd 79963a70</span><br><span class="line">79963a70  fffffff8 00000058 fffffffc 0000002c</span><br><span class="line">79963a80  fffffff8 00000060 00685a42 53265941</span><br></pre></td></tr></table></figure>

<p>[0x32cd7a88+0x58+0x28] == [0x32cd7a88+0x58+0x20]  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ecx+0x58</span><br><span class="line">32cd7ae0  e0e0e0e0 00000000 798d7c74 e0e0e0e0</span><br><span class="line">32cd7af0  00003000 00000000 00000000 e0e0e0e0</span><br><span class="line">32cd7b00  00000000 00000000 00003000 00000000</span><br></pre></td></tr></table></figure>

<p>&#x7ED3;&#x679C;&#x4E0D;&#x7B49;&#xFF0C;&#x8FD4;&#x56DE;false&#x3002;</p>
<p>&#x63A5;&#x7740;&#x8C03;&#x7528;APLib::OnTheFly&#x51FD;&#x6570;&#xFF0C;&#x6B64;&#x51FD;&#x6570;&#x6211;&#x4EEC;&#x89C1;&#x8FC7;&#xFF0C;&#x5185;&#x90E8;&#x6B7B;&#x5FAA;&#x73AF;&#x901A;&#x8FC7;rInStream::getByte&#x83B7;&#x53D6;&#x4E00;&#x4E2A;byte&#xFF0C;&#x5728;&#x901A;&#x8FC7;rOutStream::fputc&#x51FD;&#x6570;&#x5199;&#x5165;&#x6211;&#x4EEC;&#x7684;m2&#x5185;&#x5B58;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/64.png" alt="img"></p>
<p>&#x5728;rOutStream::fputc&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x540C;&#x65F6;&#x66F4;&#x65B0;&#x8BA1;&#x6570;&#x5668;&#xFF0C;&#x4F4D;&#x7F6E;&#x6B63;&#x662F;m1+0x10+0x58+0x14&#x5373;m1+7c&#x4F4D;&#x7F6E;&#xFF0C;&#x67E5;&#x770B;&#x5185;&#x5B58;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5171;&#x5FAA;&#x73AF;2aaa&#x6B21;&#x3002;</p>
<p><img src="/2021/01/28/20210128-1/65.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ecx</span><br><span class="line">32cd7a88  798d7c88 e0e0e0e0 79963a70 e0e0e0e0</span><br><span class="line">32cd7a98  00003000 00000000 00000000 00000000</span><br><span class="line">32cd7aa8  798d7cac 0019d440 396dfa90 325ab780</span><br><span class="line">32cd7ab8  00000000 00000000 798d7c9c 2cd94990</span><br><span class="line">32cd7ac8  00000000 00000000 e0000100 e0e0e0e0</span><br><span class="line">32cd7ad8  00000000 e0e0e0e0 e0e0e0e0 00000000</span><br><span class="line">32cd7ae8  798d7c74 e0e0e0e0 00003000 00002aaa //&#x6B64;&#x503C;&#x4E3A;m1+7c&#x4F4D;&#x7F6E;</span><br><span class="line">32cd7af8  00000000 e0e0e0e0 00000000 00000000</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x67E5;&#x770B;m2+2aa0&#x5904;&#x5185;&#x5B58;&#xFF0C;&#x5370;&#x8BC1;&#x4E86;&#x4E0A;&#x8FF0;&#x8BF4;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; db 0x3149c320+2aa0</span><br><span class="line">3149edc0  ff ff ff ff ff ff ff ff-ff ff e0 e0 e0 e0 e0 e0  ................</span><br><span class="line">3149edd0  e0 e0 e0 e0 e0 e0 e0 e0-e0 e0 e0 e0 e0 e0 e0 e0  ................</span><br><span class="line">3149ede0  e0 e0 e0 e0 e0 e0 e0 e0-e0 e0 e0 e0 e0 e0 e0 e0  ................</span><br><span class="line">3149edf0  e0 e0 e0 e0 e0 e0 e0 e0-e0 e0 e0 e0 e0 e0 e0 e0  ................</span><br><span class="line">3149ee00  e0 e0 e0 e0 e0 e0 e0 e0-e0 e0 e0 e0 e0 e0 e0 e0  ................</span><br><span class="line">3149ee10  e0 e0 e0 e0 e0 e0 e0 e0-e0 e0 e0 e0 e0 e0 e0 e0  ................</span><br><span class="line">3149ee20  e0 e0 e0 e0 e0 e0 e0 e0-e0 e0 e0 e0 e0 e0 e0 e0  ................</span><br><span class="line">3149ee30  e0 e0 e0 e0 e0 e0 e0 e0-e0 e0 e0 e0 e0 e0 e0 e0  ................</span><br></pre></td></tr></table></figure>

<p>&#x63A5;&#x7740;&#x8C03;&#x7528;rOutStream::flush&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x53C2;&#x4E3A;m1 +0x10&#x5C31;&#x662F;&#x6B64;&#x65F6;&#x7684;ecx</p>
<p><img src="/2021/01/28/20210128-1/66.png" alt="img"></p>
<p><img src="/2021/01/28/20210128-1/67.png" alt="img"></p>
<p>v2 = 0  v3 = 0x58 v3+this+20 = 0x2aaa &#x8FDB;&#x5165;lable_2</p>
<p>v4 = 0x58          v5 = 0x2aaa-0 = 0x2aaa</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd esi+58</span><br><span class="line">32cd7ae0  e0e0e0e0 00000000 798d7c74 e0e0e0e0</span><br><span class="line">32cd7af0  00003000 00002aaa 00000000 e0e0e0e0</span><br><span class="line">32cd7b00  00000000 00000000 00003000 00000000</span><br><span class="line">32cd7b10  3149c320 e0e00101 a0a0a0a0 a0a0a0a0</span><br><span class="line">32cd7b20  00000000 00000000 1158ffce 00f0fe6e</span><br><span class="line">32cd7b30  32bbde30 32b5b4b0 18000018 00f0fe66</span><br><span class="line">32cd7b40  399740b8 2d6998b8 00000020 00000048</span><br><span class="line">32cd7b50  00000002 32cd7ba8 141faee4 dcbaaaa8</span><br></pre></td></tr></table></figure>

<p>&#x6761;&#x4EF6;&#x5224;&#x65AD;v5 = 0x2aaa    &#xFF0C;  *(0x58+this+0x28)- *(0x58+this+0x20) = 0x3000&#x5373;&#x5224;&#x65AD;&#x5931;&#x8D25;&#xFF0C;&#x672A;&#x8D85;&#x51FA;&#x7F13;&#x51B2;&#x533A;&#x5927;&#x5C0F;</p>
<p>&#x8C03;&#x7528;rOutStream::flush_internal&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;   </p>
<p> a1 = this = m1+0x10 = 32cd7a88 </p>
<p>a2 =   *(_DWORD *)(this + 0x14) + *(_DWORD *)(v4 + this + 0x30) = m2+0 = 3149c320 </p>
<p>a3 = v5 = 0x2aaa</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd esp</span><br><span class="line">0019d348  3149c320 00002aaa 00000006 79d4f400</span><br><span class="line">0019d358  32cd7a88 00000000 0019d390 79d4ce14</span><br><span class="line">0019d368  0019d3e0 00000000 ffffffff 0019d3e0</span><br><span class="line">0019d378  00000000 00000000 00000000 0019d3bc</span><br><span class="line">0019d388  00000006 32cd7a78 0019d3c8 79d4cba0</span><br><span class="line">0019d398  1f1906d9 2cd94944 79bf3ac0 000003f2</span><br><span class="line">0019d3a8  ffffffff ffffffff 29d0e000 0019d3e0</span><br><span class="line">0019d3b8  0019d398 0019d5e4 79e42ded 00000000</span><br></pre></td></tr></table></figure>

<p>&#x8FDB;&#x5165;rOutStream::flush_interna&#x51FD;&#x6570;</p>
<p><img src="/2021/01/28/20210128-1/68.png" alt="img"></p>
<p>&#x4F20;&#x5165;a2,a3&#xFF0C;a1 = this = ecx = [this+0x24]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd ecx</span><br><span class="line">0019d440  798d6724 0019d3e0 00000000 2b885000</span><br><span class="line">0019d450  00003000 00000000 79c78c7c 0019d488</span><br><span class="line">0019d460  79c78bef 00001003 314992e8 00003000</span><br><span class="line">0019d470  2b885000 00003000 3254c26c 00000000</span><br><span class="line">0019d480  3254c26c 00000000 0019d5f0 79c788f1</span><br><span class="line">0019d490  0042d040 00003000 00003000 2b885000</span><br><span class="line">0019d4a0  00003000 1f1900e1 2cd94988 79be73c0</span><br><span class="line">0019d4b0  0019d660 00000000 0019d518 0019d518</span><br></pre></td></tr></table></figure>

<p>&#x8FDB;&#x5165;UnplibMemwrite::Write&#x51FD;&#x6570;</p>
<p><img src="/2021/01/28/20210128-1/69.png" alt="img"></p>
<p>Dest = <em>((_DWORD *)this + 5</em>4) + <em>((_DWORD *)this + 3</em>4) = 2b885000 &#x6B64;&#x503C;&#x4E3A;&#x4F20;&#x5165;&#x7684;&#x8D8A;&#x754C;&#x5730;&#x5740;</p>
<p>Src = a2 = m2  = 0x3149c320 </p>
<p>MaxCount = a3 =2aaa</p>
<p><strong>&#x56E0;&#x6B64;&#xFF0C;&#x5F53;&#x6267;&#x884C;**</strong>memcpy<strong><strong>&#x51FD;&#x6570;&#x65F6;&#xFF0C;&#x8BBF;&#x95EE;&#x8D8A;&#x754C;&#x5185;&#x5B58;&#xFF0C;</strong></strong>crash**</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; p</span><br><span class="line">(3d90.3e34): Access violation - code c0000005 (first/second chance not available)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">Time Travel Position: 583BD24:0</span><br><span class="line">eax=3149edca ebx=32cd7a88 ecx=00002aaa edx=00002aaa esi=3149c320 edi=2b885000</span><br><span class="line">eip=79df0efe esp=0019d2f4 ebp=0019d314 iopl=0         nv up ei pl nz na po cy</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000203</span><br><span class="line">mpengine!memcpy+0x4e:</span><br><span class="line">79df0efe f3a4            rep movs byte ptr es:[edi],byte ptr [esi]</span><br></pre></td></tr></table></figure>

<p>&#x6D41;&#x7A0B;&#x90E8;&#x5206;&#x53D9;&#x8FF0;&#x8F83;&#x4E3A;&#x7E41;&#x7410;&#xFF0C;&#x7B80;&#x5355;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF0C;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="/2021/01/28/20210128-1/70.png" alt="img"></p>
<h2 id="0x02&#x5229;&#x7528;&#x6F14;&#x793A;"><a href="#0x02&#x5229;&#x7528;&#x6F14;&#x793A;" class="headerlink" title="0x02&#x5229;&#x7528;&#x6F14;&#x793A;"></a>0x02&#x5229;&#x7528;&#x6F14;&#x793A;</h2><p><img src="/2021/01/28/20210128-1/71.gif" alt="img"></p>
<h2 id="0x03&#x540E;&#x8BB0;"><a href="#0x03&#x540E;&#x8BB0;" class="headerlink" title="0x03&#x540E;&#x8BB0;"></a>0x03&#x540E;&#x8BB0;</h2><p>&#x9057;&#x61BE;&#x7684;&#x662F;&#xFF0C;&#x7531;&#x4E8E;&#x77E5;&#x8BC6;&#x50A8;&#x5907;&#x548C;&#x65F6;&#x95F4;&#x539F;&#x56E0;&#xFF0C;&#x5BF9;&#x4E8E;PE&#x7578;&#x5F62;&#x6837;&#x672C;&#x7684;&#x52A8;&#x6001;&#x89E3;&#x6790;&#x548C;Asp&#x52A0;&#x5BC6;&#x58F3;&#x8131;&#x58F3;&#x90E8;&#x5206;&#x5E76;&#x6CA1;&#x6709;&#x548C;&#x5B9E;&#x9645;&#x9006;&#x5411;&#x4E2D;&#x7ED3;&#x5408;&#x8D77;&#x6765;&#xFF0C;&#x5BFC;&#x81F4;&#x6700;&#x7EC8;&#x4EC5;&#x4EC5;&#x53EA;&#x80FD;&#x5206;&#x6790;&#x6F0F;&#x6D1E;&#x5904;&#x524D;&#x540E;&#x903B;&#x8F91;&#x548C;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x800C;&#x65E0;&#x6CD5;&#x81EA;&#x5DF1;&#x5236;&#x4F5C;&#x6837;&#x672C;&#x4EE5;&#x53CA;&#x540E;&#x7EED;&#x7684;&#x5229;&#x7528;&#x5206;&#x6790;&#xFF0C;&#x4EC5;&#x6B64;&#x629B;&#x7816;&#x5F15;&#x7389;&#xFF0C;&#x5E0C;&#x671B;&#x6709;&#x540E;&#x6765;&#x5E08;&#x5085;&#x4EEC;&#x505A;&#x4EE5;&#x89E3;&#x60D1;&#x3002;</p>
<h2 id="0x04&#x65F6;&#x95F4;&#x7EBF;"><a href="#0x04&#x65F6;&#x95F4;&#x7EBF;" class="headerlink" title="0x04&#x65F6;&#x95F4;&#x7EBF;"></a>0x04&#x65F6;&#x95F4;&#x7EBF;</h2><p>2021-01-12 &#x5FAE;&#x8F6F;&#x53D1;&#x5E03;&#x5B89;&#x5168;&#x66F4;&#x65B0;</p>
<p>2021-01-15 @ccxsaber&#x7528;&#x6237;&#x7206;&#x51FA;&#x5229;&#x7528;&#x6837;&#x672C;hash</p>
<p>2021-01-28 &#x672C;&#x7BC7;&#x5206;&#x6790;&#x5B8C;&#x6210;&#x3002;</p>
<h2 id="0x05&#x53C2;&#x8003;&#x94FE;&#x63A5;"><a href="#0x05&#x53C2;&#x8003;&#x94FE;&#x63A5;" class="headerlink" title="0x05&#x53C2;&#x8003;&#x94FE;&#x63A5;"></a>0x05&#x53C2;&#x8003;&#x94FE;&#x63A5;</h2><p>[1]CVE-2021-1647 | Microsoft Defender Remote Code Execution Vulnerability</p>
<p><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1647" target="_blank" rel="noopener">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1647</a></p>
<p>[2]taviso/loadlibrary</p>
<p><a href="https://github.com/taviso/loadlibrary" target="_blank" rel="noopener">https://github.com/taviso/loadlibrary</a> </p>
<p>[3]Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator</p>
<p><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Bulazel-Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator.pdf" target="_blank" rel="noopener">https://i.blackhat.com/us-18/Thu-August-9/us-18-Bulazel-Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator.pdf</a></p>
<p>[4]Issue 1282: MsMpEng: mpengine x86 Emulator Heap Corruption in VFS API</p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1282" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1282</a></p>
<p>[5]Issue 1260: MsMpEng: Multiple problems handling ntdll!NtControlChannel commands</p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1260" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1260</a></p>
<p>[6]Samples Hash Twitter</p>
<p><a href="https://twitter.com/ccxsaber/status/1349981243920666624" target="_blank" rel="noopener">https://twitter.com/ccxsaber/status/1349981243920666624</a></p>
<p>[7]Time Travel Debugging - Overview</p>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/time-travel-debugging-overview" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/time-travel-debugging-overview</a></p>
<p>[8]Windows Defender RCE&#x6F0F;&#x6D1E;&#xFF08;CVE-2021-1647&#xFF09;&#x9884;&#x8B66;&#x66F4;&#x65B0;</p>
<p><a href="https://s.tencent.com/research/bsafe/1227.html" target="_blank" rel="noopener">https://s.tencent.com/research/bsafe/1227.html</a></p>
<p>[9]Microsoft Defender &#x8FDC;&#x7A0B;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x6F0F;&#x6D1E;&#x5B89;&#x5168;&#x98CE;&#x9669;&#x901A;&#x544A;</p>
<p><a href="https://nox.qianxin.com/article/187" target="_blank" rel="noopener">https://nox.qianxin.com/article/187</a></p>
<p>Saturn </p>
<p>2021&#x5E74;1&#x6708;28&#x65E5;21:04</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
      <div>
      
        
      
      </div>
      
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/11/10/20201109-1/" rel="next" title="CVE-2020-17087在野0day分析">
                <i class="fa fa-chevron-left"></i> CVE-2020-17087在野0day分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  




        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="Saturn35">
            
              <p class="site-author-name" itemprop="name">Saturn35</p>
              <p class="site-description motion-element" itemprop="description">心诚求之，虽不中，不远矣。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Saturn35" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zyty718@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/Saturn35_Huity" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://passport.kanxue.com/user-center-831334.htm" target="_blank" title="kanxue">
                      
                        <i class="fa fa-fw fa-book"></i>kanxue</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-漏洞原理"><span class="nav-number">2.</span> <span class="nav-text">0x01 漏洞原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02利用演示"><span class="nav-number">3.</span> <span class="nav-text">0x02利用演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03后记"><span class="nav-number">4.</span> <span class="nav-text">0x03后记</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04时间线"><span class="nav-number">5.</span> <span class="nav-text">0x04时间线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05参考链接"><span class="nav-number">6.</span> <span class="nav-text">0x05参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Saturn35</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">98.2k</span>
  
</div>











        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: '1fB9JY8xOQdkT8o7B5JMLEK4-MdYXbMMI',
        appKey: 'I5Me1NOQdPHTJgK0ELfVmocG',
        placeholder: 'Comment here...',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<script type="text/javascript" src="/js/src/click_show_text.js"></script>

<script type="text/javascript" src="/js/src/FunnyTitle.js"></script>